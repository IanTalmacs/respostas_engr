let state={players:[],currentJudge:0,questions:[],currentQuestion:null,availableAnswers:[],roundChoices:[],chooserOrder:[],chooserIndex:0}
window.addEventListener('beforeunload',e=>{e.preventDefault();e.returnValue=''})
function loadQuestions(){return fetch('questions.json').then(r=>{if(!r.ok)throw new Error('Falha ao carregar questions.json');return r.json()}).then(qs=>{state.questions=qs}).catch(err=>{console.error(err);state.questions=[]})}
function initUI(){const count=document.getElementById('player-count');const start=document.getElementById('start-game');count.addEventListener('change',renderNameInputs);renderNameInputs();start.addEventListener('click',onStartClicked);}
function renderNameInputs(){const n=Number(document.getElementById('player-count').value);const names=document.getElementById('names');names.innerHTML='';for(let i=0;i<n;i++){const inp=document.createElement('input');inp.className='name-input';inp.placeholder='Nome';names.appendChild(inp)}}
function onStartClicked(){const n=Number(document.getElementById('player-count').value);const inputs=document.querySelectorAll('.name-input');state.players=[];for(let i=0;i<n;i++){const val=(inputs[i] && inputs[i].value.trim())||('Jogador '+(i+1));state.players.push({name:val,score:0,id:i})}showScreen('screen-board');renderScores()}
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));document.getElementById(id).classList.remove('hidden')}
function renderScores(){const scores=document.getElementById('scores');scores.innerHTML='';state.players.forEach(p=>{const el=document.createElement('div');el.className='player-score';el.innerHTML=`<div>${p.name}</div><div>${p.score}</div>`;scores.appendChild(el)})}
const startRoundBtn=document.getElementById('start-round');startRoundBtn.addEventListener('click',startRound)
function startRound(){if(state.players.length<3)return;if(!state.questions || state.questions.length===0){alert('Sem perguntas restantes');return}state.currentQuestion=pickRandomQuestion();state.availableAnswers=state.currentQuestion.answers.slice();state.roundChoices=[];state.chooserOrder=state.players.map(p=>p.id).filter(id=>id!==state.currentJudge);state.chooserIndex=0;showPassToNextChooser()}
function pickRandomQuestion(){const idx=Math.floor(Math.random()*state.questions.length);return state.questions[idx]}
function showPassToNextChooser(){if(state.chooserIndex>=state.chooserOrder.length){showPassToJudge();return}const chooserId=state.chooserOrder[state.chooserIndex];const chooser=state.players.find(p=>p.id===chooserId);document.getElementById('pass-text').textContent=`passe o celular para '${chooser.name}'`;const iam=document.getElementById('i-am-button');iam.textContent=`sou '${chooser.name}'`;iam.onclick=()=>{showQuestionForChooser(chooserId)};showScreen('screen-pass')}
function showQuestionForChooser(chooserId){document.getElementById('question-text').textContent=state.currentQuestion.question;const choicesDiv=document.getElementById('choices');choicesDiv.innerHTML='';const opts=takeRandomOptions(state.availableAnswers,3);opts.forEach(opt=>{const b=document.createElement('button');b.className='choice-btn';b.textContent=opt;b.onclick=()=>{state.roundChoices.push({playerId:chooserId,text:opt});const remIndex=state.availableAnswers.indexOf(opt);if(remIndex>-1)state.availableAnswers.splice(remIndex,1);state.chooserIndex++;showPassToNextChooser()};choicesDiv.appendChild(b)});showScreen('screen-choose')}
function takeRandomOptions(arr,n){const copy=arr.slice();const out=[];while(out.length<n && copy.length){const i=Math.floor(Math.random()*copy.length);out.push(copy.splice(i,1)[0])}return out}
function showPassToJudge(){const judge=state.players[state.currentJudge];document.getElementById('pass-to-judge-text').textContent=`passe o celular para o ${judge.name}`;const b=document.getElementById('i-am-judge');b.textContent=`eu sou ${judge.name}`;b.onclick=()=>showJudgeScreen();showScreen('screen-judge-pass')}
function showJudgeScreen(){document.getElementById('judge-question').textContent=state.currentQuestion.question;const div=document.getElementById('judge-choices');div.innerHTML='';const shuffled=shuffleArray(state.roundChoices.map(c=>c.text));shuffled.forEach(txt=>{const b=document.createElement('button');b.className='choice-btn';b.textContent=txt;b.onclick=()=>{const chosen=state.roundChoices.find(c=>c.text===txt);if(chosen){const player=state.players.find(p=>p.id===chosen.playerId);player.score++;state.questions=state.questions.filter(q=>q!==state.currentQuestion);renderScores();state.currentJudge=(state.currentJudge+1)%state.players.length;showScreen('screen-board')} };div.appendChild(b)});showScreen('screen-judge')}
function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
document.addEventListener('DOMContentLoaded',()=>{initUI();loadQuestions()});